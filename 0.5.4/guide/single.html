<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>gorm-mongodb 0.5.4 - Reference Documentation</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Style" charset="utf-8"/>
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    </head>
    <body class="body">
        <div id="header">
            <div class="images"><br/><br/>
                <a href="http://grails.org" target="_blank"><img alt="The Grails Framework" src="../img/grails.png" border="0"/></a>
                <span style="right:30px; top:20px; position:absolute;">
                    <a href="../index.html" target="_top">Frames</a> | <a href="index.html" target="_top">No Frames</a><br/><br/>
                    <a href="http://springsource.com" target="_blank"><img alt="SpringSource - A Division of VMware" src="../img/springsource-logo.png" border="0"/></a>
                </span>
            </div>
            <div class="message">gorm-mongodb</div>
            <h1>gorm-mongodb - Reference Documentation</h1>
            <p><strong>Authors:</strong> Juri Kuehn</p>
            <p><strong>Version:</strong> 0.5.4</p>
            <em></em>
        </div>

        <div id="toc">
            <h2>Table of Contents</h2>
            <div class="tocItem" style="margin-left:0px"><a href="#1. Introduction">1. Introduction</a></div><div class="tocItem" style="margin-left:0px"><a href="#2. Quickstart">2. Quickstart</a></div><div class="tocItem" style="margin-left:0px"><a href="#3. Mongo Entities">3. Mongo Entities</a></div><div class="tocItem" style="margin-left:0px"><a href="#4. Querying">4. Querying</a></div><div class="tocItem" style="margin-left:0px"><a href="#5. Low Level Access">5. Low Level Access</a></div>
        </div>
        <div id="content">
            <h1><a name="1. Introduction">1. Introduction</a></h1><a href="http://www.mongodb.org/" target="blank">MongoDB</a> is a scalable, high-performance, schemafree and <a href="http://www.mongodb.org/display/DOCS/Production+Deployments" target="blank">production ready</a> NoSQL database. This plugin implements the GORM functionality for MongoDB. Under the hood it uses <a href="http://code.google.com/p/morphia/" target="blank">Morphia</a> as a lightweight type-safe library for mapping domain classes to/from MongoDB.<p class="paragraph"/><h3>Features</h3><p class="paragraph"/>Features implemented to far:
<ul class="star">
<li>Instance methods: save, delete</li>
<li>Class methods: get, find, findAll, delete, deleteAll, exists, count, list</li>
<li>Dynamic finders like findAllByNameAndDegreeBetween(...)</li>
<li>Constraints and validation support</li>
<li>Automatic timestamping of dateCreated and lastUpdated</li>
<li>Gorm events beforeSave, afterSave, beforeDelete, afterDelete (others, like afterLoad are supported by <a href="http://code.google.com/p/morphia/wiki/LifecycleMethods" target="blank">Morphia</a> )</li>
<li>Works with MongoDB 1.4 and 1.6</li>
<li>AST Transformations that inject all necessary fields and annotations for morphia</li>
<li>Lazy references supported</li>
<li>generate-all support</li>
</ul><p class="paragraph"/>See the <a href="2.%20Quickstart.html">quickstart</a> page for a usage example. You can also download a <a href="http://github.com/downloads/jkuehn/gorm-mongodb/petclinic-mongodb.zip" target="blank">petclinic sample application port</a> which uses gorm-mongodb to see the use of embedded and referenced domain classes.<p class="paragraph"/><h3>Questions and Bug Reports</h3>
<ul class="star">
<li><a href="http://www.grails.org/Mailing+lists" target="blank">Mailing list</a></li>
<li><a href="http://jira.codehaus.org/browse/GRAILSPLUGINS/component/14453" target="blank">Bug tracker</a></li>
</ul><p class="paragraph"/><h3>Other links</h3>
<ul class="star">
<li><a href="http://www.grails.org/" target="blank">Grails Framework</a></li>
<li><a href="http://grails.org/doc/latest/index.html" target="blank">Grails Documentation</a></li>
<li><a href="http://github.com/mongodb/mongo-java-driver" target="blank">MongoDB Java Driver</a></li>
<li><a href="http://www.mongodb.org/display/DOCS/Java+Language+Center" target="blank">MongoDB Java Language Center</a></li>
<li><a href="http://github.com/mpriatel/mongodb-grails" target="blank">MongoDB Grails Plugin</a> that exposes a mongo bean for interaction with MongoDB</li>
</ul><p class="paragraph"/> 
<h3>Change Log</h3><p class="paragraph"/>see <a href="http://github.com/jkuehn/gorm-mongodb/blob/master/CHANGES.textile" target="blank">here</a><p class="paragraph"/><h3>Author:</h3>
<ul class="star">
<li>Juri Kuehn (juri.kuehn at gmail.com)</li>
</ul><p class="paragraph"/><h1><a name="2. Quickstart">2. Quickstart</a></h1>Here you will find a step by step guide to set up a test project that uses the gorm-mongodb plugin to manipulate domain classes in Grails<p class="paragraph"/><h2>Creating a test project that uses gorm-mongodb</h2><p class="paragraph"/>We are going to create a new Grails application that has only one domain class: Car. Using the generate-all command we will generate the controllers and views necessary to manipulate instances of that domain.<p class="paragraph"/>Let's start off, create a new Grails project and install the gorm-mongodb plugin:<p class="paragraph"/><div class="code"><pre>&#62; grails create&#45;app MongoGrailsQuickstart
&#62; cd MongoGrailsQuickstart
&#62; grails install&#45;plugin gorm&#45;mongodb</pre></div><p class="paragraph"/>The gorm-mongodb plugin provides a create-mongodb-class command that creates a stub for the domain class, as well as corresponding test cases. Let's call it:<p class="paragraph"/><div class="code"><pre>&#62; grails create&#45;mongodb&#45;class Car</pre></div><p class="paragraph"/>MongoDB domain classes are put into the grails-app/mongo directory. Now we need to edit some files: Config.groovy for the database connection and our new Car domain, where we want to put some fields:<p class="paragraph"/><strong class="bold">grails-app/conf/DataSource.groovy</strong><p class="paragraph"/><div class="code"><pre>mongodb &#123;
  host = '192.168.1.36' // adjust <span class="java&#45;keyword">this</span> according to your settings
  port = 27017
  database = 'test'
&#125;</pre></div><p class="paragraph"/>Now the fields and constraints<p class="paragraph"/><strong class="bold">grails-app/mongo/mongograilsquickstart/Car.groovy</strong><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> mongograilsquickstart<p class="paragraph"/>class Car &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">String</span> brand<p class="paragraph"/>    <span class="java&#45;object">int</span> ps // horsepower
    Date buildDate<p class="paragraph"/>    Date dateCreated // autoset by plugin
    Date lastUpdated // autoset by plugin<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        brand nullable:<span class="java&#45;keyword">true</span>
        ps min: 30, max: 1001
    &#125;
&#125;</pre></div><p class="paragraph"/>Now generate the controllers and views and fire up the app!<p class="paragraph"/><div class="code"><pre>&#62; grails generate&#45;all mongograilsquickstart.Car
&#62; grails run&#45;app</pre></div><p class="paragraph"/>Now point your browser to http://localhost:8080/MongoGrailsQuickstart <strong class="bold">Done!</strong><h1><a name="3. Mongo Entities">3. Mongo Entities</a></h1><h3>Creating Mongo Entities</h3><p class="paragraph"/>Classes that should be mapped to MongoDB should be put into the <em class="italic">/grails-app/mongo</em> directory. You can also use the <code>create-mongodb-class</code> command to generate mongo classes.<p class="paragraph"/><div class="code"><pre>&#62; grails create&#45;mongodb&#45;class Car</pre></div><p class="paragraph"/>Classes that should be mapped have to be put into the grails-app/mongo directory or have to be annotated with the <code>com.google.code.morphia.annotations.Entity</code> annotation.<p class="paragraph"/><h3>Dependency Injection</h3><p class="paragraph"/>Mapped MongoDB entities are autowires as described in the <a href="http://grails.org/doc/1.3.x/guide/8.%20The%20Service%20Layer.html#8.3%20Dependency%20Injection%20and%20Services" target="blank">Grails user guide</a><p class="paragraph"/><strong class="bold">Limitation:</strong> injected properties have to be marked as transient, otherwise a MappingException will occurr.<p class="paragraph"/><div class="code"><pre>class Car &#123;<p class="paragraph"/>  <span class="java&#45;keyword">transient</span> mongo // autowired by spring
  <span class="java&#45;keyword">transient</span> cacheService // autowired by spring<p class="paragraph"/>  def afterSave = &#123;
    cacheService.invalidate('car', id)
  &#125;
&#125;</pre></div><p class="paragraph"/><h1><a name="4. Querying">4. Querying</a></h1>You have two options for getting objects out of your MongoDB: by using queries/filters or the dynamic finders.<p class="paragraph"/><h2>Filters</h2><p class="paragraph"/>The mongo domain classes provide <code>find</code> and <code>findAll</code> methods that accept a map with filtering constraints and optional query options. Every filter consists of a fieldname, operator and a value. If no operator is given, = is assumed.<p class="paragraph"/><strong class="bold">Examples</strong><p class="paragraph"/><div class="code"><pre>Exampledomain.findAll(&#91;<span class="java&#45;quote">"yearsOfOperation &#62;"</span>: 5&#93;, &#91;max:20, sort:'yearsOfOperation'&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"rooms.maxBeds &#62;="</span>: 2, <span class="java&#45;quote">"rooms.occupied"</span>: <span class="java&#45;keyword">false</span>&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"rooms.bathrooms exists"</span>: 1&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"stars in"</span>: &#91;3,4&#93;&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"age &#62;="</span>: age&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"age ="</span>: age&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"age"</span>: age&#93;) // (<span class="java&#45;keyword">if</span> no <span class="java&#45;keyword">operator</span>, = is assumed)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"age !="</span>: age&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"age in"</span>: ageList&#93;)
Exampledomain.findAll(&#91;<span class="java&#45;quote">"customers.loyaltyYears in"</span>, yearsList&#93;)</pre></div><p class="paragraph"/>Valid operators are "=", "==","!=", "&#60;&#62;", "&#62;", "&#60;", "&#62;=", "&#60;=", "in", "nin", "all", "size", "exists". Under the covers the plugin uses Morhias <a href="http://code.google.com/p/morphia/source/browse/trunk/morphia/src/main/java/com/google/code/morphia/Datastore.java" target="blank">Datastore</a> and its <a href="http://code.google.com/p/morphia/source/browse/trunk/morphia/src/main/java/com/google/code/morphia/query/Query.java" target="blank">Query</a> implementation<p class="paragraph"/><h3>Query options</h3><p class="paragraph"/>You can pass query options to find / findAll for skipping, limiting and sorting your resultset. The query options are represented by a map like <code>max: 30, offset: 10, sort:"lastname,firstname"</code><p class="paragraph"/><strong class="bold">max</strong>
Limits the result set to given number of entries<p class="paragraph"/><strong class="bold">offset</strong>
Skips the given number of results<p class="paragraph"/><strong class="bold">sort</strong>
Sorts the results. You can provide multiple fieldnames delimited by comma. If you want the results to be sorted in descending order, you have to prepend the fieldname with a minus: <code>sort:"-lastname,-firstname,age"</code><p class="paragraph"/><h2>Dynamic finders</h2><p class="paragraph"/>The dynamic finders provided by gorm-mongodb work just as the <a href="http://grails.org/doc/latest/ref/Domain%20Classes/findAllBy.html" target="blank">default gorm finders</a> (example: <code>Car.findAllByNameAndPsGreaterThan("Polo", 50, sort: "-ps")</code>). 
<h1><a name="5. Low Level Access">5. Low Level Access</a></h1>If you want to, you can also access <a href="http://code.google.com/p/morphia/" target="blank">Morphia's</a> Datastore or the underlying <a href="http://github.com/mongodb/mongo-java-driver" target="blank">MongoDB Java Driver</a> directly. Morphia is used to transform between MongoDB DBObjects and annotated POJOs. The Java Driver can be used for slick low level access to MongoDB.<p class="paragraph"/><h2>Access using the mongo bean</h2><p class="paragraph"/>The bean <code>mongo</code> provides access to the configured java driver and morphia instance (since 0.1.2):<p class="paragraph"/><strong class="bold">usage:</strong><p class="paragraph"/><div class="code"><pre>class MongoController &#123;
    def mongo<p class="paragraph"/>    def lowlevel = &#123;
        mongo.mongo     // com.mongodb.Mongo &#45; already connected
        mongo.db        // com.mongodb.DB &#45; configured db
        mongo.morphia   // com.google.code.morphia.Morphia &#45; used <span class="java&#45;keyword">for</span> mapping
        mongo.datastore // com.google.code.morphia.Datastore &#45; ORM layer<p class="paragraph"/>        // com.mongodb.DBCollection that holds entities <span class="java&#45;keyword">for</span> given class
        mongo.getCollection(Person.class)
    &#125;
&#125;</pre></div><p class="paragraph"/><h2>Access using the collection property</h2><p class="paragraph"/>Every MongoDB domain has a <code>collection</code> property for convenient access to the drivers <a href="http://api.mongodb.org/java/current/com/mongodb/DBCollection.html" target="blank">DBCollection</a> instance:<p class="paragraph"/><strong class="bold">usage example:</strong><p class="paragraph"/><div class="code"><pre>Project.collection.insert(<span class="java&#45;keyword">new</span> BasicDBObject('name', 'Project MongoDB'))</pre></div><p class="paragraph"/>
        </div>
        <div id="footer">
             
        </div>
    </body>
</html>
